# UFO³ Galaxy - 系统架构总览

**版本**: 1.0
**作者**: Manus AI
**日期**: 2026-01-19

---

## 1. 系统概述

UFO³ Galaxy 是一个面向极客松竞赛的分布式 AI 代理系统。它通过自然语言命令协调多个异构设备（Windows PC、Android 设备、云服务器）完成复杂任务。系统的核心设计理念是"一语掌控全局"——用户只需用自然语言表达意图，系统会自动理解、规划并执行跨设备的协同任务。

## 2. 架构设计

### 2.1. 总体架构图

```
┌─────────────────────────────────────────────────────────────────────┐
│                         Tailscale 虚拟私有网络                         │
│                    (100.x.x.x IP 地址空间)                            │
└─────────────────────────────────────────────────────────────────────┘
                                   │
        ┌──────────────────────────┼──────────────────────────┐
        │                          │                          │
        ▼                          ▼                          ▼
┌───────────────┐          ┌──────────────┐          ┌──────────────┐
│  Windows PC   │          │   Android    │          │  华为云服务器  │
│ (100.123.x.x) │          │ (100.106.x.x)│          │ (100.82.x.x) │
└───────────────┘          └──────────────┘          └──────────────┘
        │                          │                          │
        │                          │                          │
   ┌────┴────┐                     │                     ┌────┴────┐
   │         │                     │                     │         │
   ▼         ▼                     ▼                     ▼         │
┌─────┐  ┌─────┐              ┌─────┐              ┌─────┐        │
│Node │  │Node │              │浮动 │              │Node │        │
│ 50  │  │ 43  │              │窗口 │              │ 60  │        │
│(脑) │  │(手) │              │客户端│              │(学者)│        │
└─────┘  └─────┘              └─────┘              └─────┘        │
   │         │                     │                     │         │
   │    ┌─────┐                    │                     │         │
   │    │Node │                    │                     │         │
   │    │ 48  │                    │                     │         │
   │    │(艺术)│                    │                     │         │
   │    └─────┘                    │                     │         │
   │         │                     │                     │         │
   └─────────┴─────────────────────┴─────────────────────┴─────────┘
                                   │
                          AIP/1.0 WebSocket 通信
```

### 2.2. 节点职责

系统采用"大脑-手-眼"的隐喻设计，每个节点都有明确的职责。

| 节点 | 角色 | 部署位置 | 核心功能 |
| :--- | :--- | :--- | :--- |
| **Node 50** | 大脑 (Transformer) | Windows PC (Podman 容器) | NLU 引擎、任务理解、任务分发、协调 |
| **Node 43** | 工匠之手 (BambuLab) | Windows PC (Podman 容器) | 控制 Bambu Lab 3D 打印机 |
| **Node 48** | 艺术家 (MediaGen) | Windows PC (Podman 容器) | 调用 PixVerse API 生成 AI 视频 |
| **Node 60** | 学者 (Cloud Compute) | 华为云服务器 | 量子计算、AI 推理、异构计算 |
| **Windows Client** | 操作者 | Windows 桌面进程 | UI 侧边栏、桌面自动化 |
| **Android Client** | 移动观察者 | Android 设备 | 悬浮窗、语音/文本输入、传感器 |

### 2.3. 通信协议

所有节点和客户端之间通过 **AIP/1.0 (Agent Interaction Protocol)** 进行通信。这是一个基于 WebSocket 和 JSON 的自定义协议。

**核心设计原则**：
- **统一格式**：所有消息都遵循相同的 JSON 结构
- **双向通信**：支持命令、响应、事件和心跳
- **异步非阻塞**：使用 WebSocket 实现实时双向通信
- **可扩展性**：`payload` 字段可以承载任意结构的数据

**消息示例**：

```json
{
    "protocol": "AIP/1.0",
    "message_id": "msg_1737270000123",
    "timestamp": "2026-01-19T09:00:00Z",
    "from": "windows-client",
    "to": "Node_50",
    "type": "command",
    "payload": {
        "command": "打印一个警告标志",
        "context": {
            "user_location": "office",
            "urgency": "high"
        }
    }
}
```

## 3. 数据流

### 3.1. 典型任务执行流程

以"打印一个警告标志"为例，展示完整的数据流：

```
1. [用户] 在 Android 悬浮窗中说："打印一个警告标志"
   ↓
2. [Android Client] 将语音转为文本，封装为 AIP 命令消息
   ↓
3. [Android Client] 通过 WebSocket 发送到 Node 50
   ↓
4. [Node 50] NLU 引擎理解命令意图
   ↓
5. [Node 50] 生成任务计划：
   {
     "intent": "3d_print",
     "target_nodes": ["Node_43"],
     "tasks": [{
       "node": "Node_43",
       "action": "start_print",
       "parameters": {"model_file": "warning_sign.3mf"}
     }]
   }
   ↓
6. [Node 50] 将任务分发给 Node 43
   ↓
7. [Node 43] 连接到 Bambu Lab 打印机，通过 MQTT 发送打印指令
   ↓
8. [Node 43] 打印机开始打印，Node 43 监控进度
   ↓
9. [Node 43] 打印完成后，发送响应消息给 Node 50
   ↓
10. [Node 50] 将结果转发给 Android Client
    ↓
11. [Android Client] 在悬浮窗中显示："打印完成！"
```

### 3.2. 跨节点协同示例

更复杂的任务可能需要多个节点协同工作。例如："优化路径并生成视频"：

```
1. [用户] 在 Windows 侧边栏输入："优化从北京到上海的路线，并生成一个演示视频"
   ↓
2. [Node 50] 理解为两个子任务：
   - 任务 A: 路径优化 → Node 60
   - 任务 B: 视频生成 → Node 48 (依赖任务 A 的结果)
   ↓
3. [Node 50] 先将任务 A 发送给 Node 60
   ↓
4. [Node 60] 使用 IBM Quantum 执行量子优化算法
   ↓
5. [Node 60] 返回最优路径结果给 Node 50
   ↓
6. [Node 50] 将任务 B 和路径结果一起发送给 Node 48
   ↓
7. [Node 48] 调用 PixVerse API，生成路径演示视频
   ↓
8. [Node 48] 视频生成完成后，自动下载到本地
   ↓
9. [Node 48] 返回视频下载链接给 Node 50
   ↓
10. [Node 50] 将结果转发给 Windows Client
    ↓
11. [Windows Client] 在侧边栏显示视频链接，并自动在浏览器中打开
```

## 4. 技术选型

### 4.1. 网络层

**Tailscale** 被选为网络层的核心技术，原因如下：

- **零配置 VPN**：无需手动配置端口转发或防火墙规则
- **跨平台支持**：支持 Windows、Linux、Android、iOS 等所有主流平台
- **安全性**：基于 WireGuard 协议，提供端到端加密
- **NAT 穿透**：即使设备在不同的网络环境中，也能直接通信

### 4.2. 容器化

**Podman Desktop** 被选为容器化工具，而非 Docker，原因如下：

- **无守护进程**：Podman 不需要后台守护进程，更轻量
- **Windows 原生支持**：在 Windows 上运行更稳定
- **兼容 Docker**：支持 Docker Compose 文件格式

### 4.3. AI 模型管理

**OneAPI** 被用于统一管理多个 LLM 模型，提供了一个统一的 API 接口，可以轻松切换不同的模型提供商（DeepSeek、Gemini、GPT-4 等），而无需修改代码。

### 4.4. UI 框架

- **Windows**: 使用 **Tkinter** 实现侧边栏，因为它是 Python 内置的 GUI 库，无需额外安装依赖。
- **Android**: 使用 **Kotlin** + **FloatingWindow** + **SpeechRecognizer**，这是 Android 原生 API，性能最优。

## 5. 安全性考虑

- **网络隔离**：所有设备都在 Tailscale 虚拟网络中，不暴露在公网上。
- **API 密钥管理**：所有 API 密钥都通过环境变量配置，不硬编码在代码中。
- **权限控制**：Android 客户端需要用户明确授予悬浮窗和麦克风权限。

## 6. 可扩展性

系统设计时充分考虑了可扩展性：

- **新节点**：只需实现 AIP 协议，即可加入系统。
- **新能力**：在 Node 50 的 NLU 引擎中添加新的规则或训练新的模型。
- **新设备**：任何支持 WebSocket 的设备都可以成为客户端。

## 7. 性能优化

- **异步通信**：所有节点都使用异步 I/O，避免阻塞。
- **容器化隔离**：每个节点运行在独立的容器中，互不干扰。
- **按需启动**：节点可以根据需要动态启动和停止。

---

## 总结

UFO³ Galaxy 是一个高度模块化、可扩展的分布式 AI 代理系统。它通过 Tailscale 组建安全网络，通过 AIP/1.0 协议实现节点间通信，通过 Node 50 的 NLU 引擎实现智能任务分发。系统整合了 3D 打印、AI 视频生成、量子计算等多种能力，展示了 AI 在异构设备协同中的巨大潜力。
